{% extends "base.html" %}

{% block content %}
<div class="row">
    <div class="col-md-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1>Admin Dashboard</h1>
            <a href="{{ url_for('new_exam') }}" class="btn btn-primary">Create New Exam</a>
        </div>

        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#setCountdownModal">
            Set Countdown
        </button>

        <div class="modal fade" id="setCountdownModal" tabindex="-1" aria-labelledby="setCountdownModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="setCountdownModalLabel">Set Countdown</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <form action="" method="post">
                            <div class="form-group">
                                <label for="countDownDate" class="form-label">Countdown Date</label>
                                <input type="datetime-local" class="form-control" id="countDownDate" name="countDownDate" required>
                            </div>
                            <button type="submit" class="btn btn-primary">Set Countdown</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    

        <script>
            function setCountdown(countDownDate) {
                // Update the count down every 1 second
                var x = setInterval(function() {
                
                  // Get today's date and time
                  var now = new Date().getTime();
                
                  // Find the distance between now and the count down date
                  var distance = countDownDate - now;
                
                  // Time calculations for days, hours, minutes and seconds
                  var days = Math.floor(distance / (1000 * 60 * 60 * 24));
                  var hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                  var minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                  var seconds = Math.floor((distance % (1000 * 60)) / 1000);
                
                  // Display the result in the element with id="demo"
                  document.getElementById("demo").innerHTML = days + "d " + hours + "h "
                  + minutes + "m " + seconds + "s ";
                
                  // If the count down is finished, write some text
                  if (distance < 0) {
                    clearInterval(x);
                    document.getElementById("demo").innerHTML = "EXPIRED";
                  }
                }, 1000);
            }
            
            document.addEventListener('DOMContentLoaded', function() {
                document.querySelector('form').addEventListener('submit', function(event) {
                    event.preventDefault();
                    var countDownDate = new Date(document.getElementById('countDownDate').value).getTime();
                    setCountdown(countDownDate);
                    document.querySelectorAll('.gate-page').forEach(function(page) {
                        var now = new Date().getTime();
                        var distance = countDownDate - now;
                        var days = Math.floor(distance / (1000 * 60 * 60 * 24));
                        var hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                        var minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                        var seconds = Math.floor((distance % (1000 * 60)) / 1000);
                        page.querySelector('.countdown').innerHTML = days + "d " + hours + "h "
                        + minutes + "m " + seconds + "s ";
                    });
                });
            });
        </script>
    

        <div class="card">
            <div class="card-header">
                <h3>Manage Exams</h3>
            </div>
            <div class="card-body">
                {% if exams %}
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Exam Name</th>
                                    <th>Description</th>
                                    <th>Duration (mins)</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for exam in exams %}
                                <tr>
                                    <td>{{ exam.name }}</td>
                                    <td>{{ exam.description }}</td>
                                    <td>{{ exam.duration }}</td>
                                    <td>
                                        <div class="d-flex justify-content-between align-items-center">
                                            <a href="{{ url_for('manage_questions', exam_id=exam.id) }}" 
                                               class="btn btn-sm btn-info">
                                                Manage Questions
                                            </a>
                                            <form action="{{ url_for('delete_exam', exam_id=exam.id) }}" method="POST" class="d-inline" onsubmit="return confirm('Are you sure you want to delete this exam? This action cannot be undone.');">
                                                <button type="submit" class="btn btn-sm btn-danger">
                                                    <i class="fas fa-trash-alt"></i> Delete
                                                </button>
                                            </form>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <p>No exams created yet.</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}
